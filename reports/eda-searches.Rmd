---
title: "EDA buscas"
output: html_notebook
author: Aline Costa
---

O objeto principal da análise são as buscas e a navegação depois da busca. Criamos esses dados a partir dos dados originais da wikimedia em `/data/search_data.csv`. 

Aqui, exploramos esses dados. 

```{r setup}
library(tidyverse)
library(here)
library(lubridate)
theme_set(theme_bw())
```

```{r ETL}
buscas = read_csv(here::here("data/search_data.csv"))
```

```{r}
buscas %>% 
    ggplot(aes(x = results)) + 
    geom_histogram(binwidth = 5) 
```

### What is our daily overall clickthrough rate? How does it vary between the groups?
Passando os dias, como a média vai evoluindo? Depois add os grupos.

Criando a coluna de data
```{r}
buscas_com_data <- buscas %>%
    mutate(data = format(session_start_date, "%Y-%m-%d")) 
```

Vendo a distribuição dos dados
```{r}
buscas_com_data %>%
    ggplot(aes(x = data, y = num_clicks)) + 
    geom_point() 
```

Trabalhando com a média de dias. Considerando que a média de cliques é a média geral de cliques em cada dia.
```{r}
media <- buscas_com_data %>% 
  group_by(data) %>% 
  summarise(media_click = mean(num_clicks)) # ajustar para mostrar todas as datas

media %>%
    ggplot(aes(x = as.Date(data), y = media_click)) +
    geom_line() + 
    labs(
        y = "Média de cliques",
        x = "Data",
        title = "Média de cliques por dia") +
    geom_point()
```
Observando a visualização acima pordemos ver que, de modo geral, a média de cliques varia entre X e Y. 

E considerando com os grupos:
```{r}
media <- buscas_com_data %>% 
  group_by(data, group) %>% 
  summarise(media_click = mean(num_clicks)) # ajustar para mostrar todas as datas


media %>%
    ggplot(aes(x = as.Date(data), y = media_click, color = group)) +
    geom_line() + 
    labs(
        y = "Média de cliques",
        x = "Data",
        title = "Média de cliques por dia e grupos") +
    geom_point()
```

E quando consideramos os dois grupos separadamente a diferença é bem visível. No grupo 'a', a variação fica entre X e Y e no grupo 'b'...


### Which results do people tend to try first? How does it change day-to-day?
Quais resultados as pessoas tendem a tentar primeiro? Como isso muda no dia-a-dia?

Vamos ver primeiro os 16 resultados mais clicados. Ressaltando que removemos os casos onde não houve clique em nenhum link.
```{r}
busca_com_contagem_cliques <- buscas %>% 
  group_by(first_click) %>% 
  summarise(count_click = n()) %>%
    arrange(desc(count_click)) %>%
    top_n(16)

busca_com_contagem_cliques %>%
    filter (first_click != "NA") %>%
    ggplot(aes(x = first_click, y = count_click)) +
    geom_point() +
    scale_y_continuous(limits=c(0, 25000)) +
    scale_x_continuous(breaks=seq(1, 20, 1)) + 
    labs(
        y = "Quantidade de vezes que foi clicado primeiro",
        x = "Posição do resultado nas 16 posições mais clicadas",
        title = "Classificação do primeiro clique para os resultados da busca") 

```

Pelo gráfico acima podemos ver que os resultados que as pessoas tendem a clicar primeiro são os primeiros da lista. Mais especificamente, a sequência de resultados mais acessados é igual para os 10 primeiros resultados. Depois varia um pouco. 

Para analisar a distribuição dos cliques ao longo dos dias vamos tentar comparar os dias da semana.

```{r}
buscas_com_data %>% 
    filter (first_click < 25) %>%
    ggplot(aes(color = data, x = first_click, alpha=0.5)) + 
    geom_density() + 
    labs(
        y = "Densidade",
        x = "Posição do 1º clique no resultado da busca",
        title = "Distribuição dos primeiros cliques ao longo dos dias ") 
```

Pela visualização acima não conseguimos distriguir variação significante nos primeiros links clicados (limitados aos 25 primeiros) ao longo dos dias. Vamos visualizar os dias em gráficos separados... 

```{r}
buscas_com_data %>% 
    filter (first_click < 25) %>%
    ggplot(aes(x = first_click, fill = data)) +
    geom_histogram(binwidth = 2, na.rm = TRUE) +
    facet_wrap(~ data, nrow=2) +
    labs(
        y = "Densidade",
        x = "Posição do 1º clique no resultado da busca",
        title = "Distribuição dos primeiros cliques ao longo dos dias ") 
```

Podemos ver que a distribuição de cliques segue praticamente o mesmo formato ao longo dos dias, se concentrando nos 5 primeiros resultados da busca. O que podemos identificar também são algumas poucas diferenças nas caldas das distribuições e que no dia 05  aparentemente foram realizadas menos buscas.

Para visualizar melhor as diferenças, fixar uma porcentagem e ver quais posições são clicadas por aquele pessoal OU fixar a posição e ver quantos por cento clicam nela.



### What is our daily overall zero results rate? How does it vary between the groups?
Qual é a nossa taxa de resultados zero no geral? Como isso varia entre os grupos?

Vamos ver a distribuição de resultados zero ao longo dos dias. 

```{r}
buscas_com_data %>% 
    filter(results == 0) %>% 
    ggplot(aes(x = data)) + 
    geom_bar() +
    labs(
        y = "Quantidade de buscas com zero resultados",
        x = "Data",
        title = "Distribuição de buscas com zero resultados ao longo dos dias ") 
```

Para visualizar melhor a proporção de resultados zero vamos adicionar também a quantidade total de buscas.

Criando a coluna de é busca "eh_zero"
```{r}
buscas_com_results_zero <- buscas_com_data %>%
    mutate(eh_resultado_zero = results == 0) 
```


```{r}
buscas_com_results_zero %>% 
    filter(!is.na(results) & !is.na(data)) %>%
    ggplot(aes(data, fill=eh_resultado_zero)) + 
    geom_bar(position=position_dodge()) +
    labs(
        y = "Quantidade de buscas com zero resultados",
        x = "Data",
        title = "Distribuição de buscas com zero resultados ao longo dos dias ") 
```
rlang::last_error()

HERE ver o gráfico acima em porcentagem?

No geral, a quantidade de resultados zero retornados por cada grupo.

```{r}
buscas_com_data %>% 
    filter(!is.na(results) & results == 0) %>% 
    ggplot(aes(x = group, fill=group)) + 
    geom_bar() +
    labs(
        y = "Quantidade de buscas com zero resultados",
        x = "Grupo",
        title = "Distribuição de buscas com zero resultados pelos grupos ") 
```

Vemos que o grupo de buscas com o Algoritmo 'a' retorna uma maior quantidade de buscas com zero resultados. MAS TENHO A MESMA QUANTIDADE DE REGISTROS PARA OS DOIS ALGORITMOS? USAR A PROPORÇÃO!

### Let session length be approximately the time between the first event and the last event in a session. Choose a variable from the dataset and describe its relationship to session length. Visualize the relationship.
A duração da sessão é aproximadamente o tempo entre o primeiro e o último evento de uma sessão. Escolha uma variável do conjunto de dados e descreva sua relação com o tamanho da sessão. Visualize o relacionamento.

Vamos estudar a relação da quantidade de cliques com o tamanho da sessão.

Vendo a distribuição dos dados para as variáveis session_length e num_clicks
```{r}
buscas_com_data %>%
    ggplot(aes(x = session_length, y = num_clicks)) + 
    geom_point() 
```

Desconsiderando os registros de session_length zero
```{r}
buscas_com_data %>%
    filter (session_length != 0) %>%
    ggplot(aes(x = session_length, y = num_clicks)) + 
    geom_point() 
```

A primeira impressão observando o gráfico acima é que o tamanho da sessão não teria muita influência na quantidade de cliques. Esperaríamos que as sessões maiores apresentassem uma maior qtd de cliques, mas essa concentração é maior em sessões menores. 

Vamos ver como é distribuído o tamanho das sessões.
```{r}
buscas_com_data %>%
    filter (session_length != 0) %>%
    ggplot(aes(x = session_length)) + 
    geom_density() 
```

Vamos analisar a distribuição aplicando o log de base 10 e vendo para grupos diferentes.

```{r}
buscas_com_data %>%
    filter (session_length != 0) %>%
    ggplot(aes(x = session_length, y = num_clicks)) + 
    geom_point() +
    scale_x_continuous(trans = 'log10') +
    facet_wrap(~ group)
```

Mais cliques em sessões de tamanho médio?

Para confirmar/refutar vamos ver os valores de correlação:
```{r}
buscas_com_data %>%
    summarise(
    pearson = cor(session_length, num_clicks, method = "pearson"), 
    spearman = cor(session_length, num_clicks, method = "spearman"), 
    kendall = cor(session_length, num_clicks, method = "kendall")
  )
```

Valores de correlação baixa. Então...

Vamos separar os dados por grupos para ver se a correlação é maior para algum deles.
HERE colocar dois de pontos lado a lado

Para o grupo 'a'
```{r}
buscas_com_data %>%
    filter(group == 'a') %>%
    summarise(
    pearson = cor(session_length, num_clicks, method = "pearson"), 
    spearman = cor(session_length, num_clicks, method = "spearman"), 
    kendall = cor(session_length, num_clicks, method = "kendall")
  )
```

Para o grupo 'b'
```{r}
buscas_com_data %>%
    filter(group == 'b') %>%
    summarise(
    pearson = cor(session_length, num_clicks, method = "pearson"), 
    spearman = cor(session_length, num_clicks, method = "spearman"), 
    kendall = cor(session_length, num_clicks, method = "kendall")
  )
```

A correlação é maior para o grupo 'b'.


session_length x num_clicks
sessões maiores tem maior qtd de cliques?
plotar o tamanho das sessões. gráfico ruim
plota a distribuição com pontos, normal
vê no outro lab como alterei os dados p ver as relações
depois separa por grupos para ver se muda
muda ao longo dos dias?
existe correlação ou não? positiva? negativa?
colocar os labels


